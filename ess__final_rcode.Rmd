---
title: "project_ess_final"
author: "Jeremy Knox"
date: "12/8/2018"
output: html_document
---

Libraries and Data Frames:
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(car)
library(userfriendlyscience)
library(knitr)
library(kableExtra)
library(effsize)
library(ggrepel)
library(reshape2)
library(stargazer)
library(Hmisc)
library(lmtest)
library(corrplot)
library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)
library(stringr)
library(dplyr)
task1 = read_csv("climate_opinion.csv")
task2 = read.csv("ucsb_climate.csv", row.names = 1)
task3 = read_csv("tmas_df.csv")
task4 = read_csv("PesticideResidues.csv")
task5 = read_csv("ca_county_pesticides.csv")
```

Task 1: Climate Change Opinions (Yale Program on Climate Change Commu- nication)
```{r}
# correlation matrix 
sapply(task1, class)
subset_task1 = task1 %>% select(happening,consensus,discuss,mediaweekly,bachelors,poverty_rate)
cm = rcorr(as.matrix(subset_task1))
cm

# dependent "happening" is derived from a binomial variable with "yes", "no" or "dont know" responses. Then aggreagated at the state level and given as a percent of respondents who repsponded yes.
lm = lm(data = task1, happening ~ bachelors + poverty_rate + coastline) 
summary(lm) # NOT INCLUDED variables because of likely reverse causuality: "consensus", "discuss", "mediaweekly"
plot(lm) # looks homoskedastic 
bptest(lm) # p = .65 thus residuals most likley constant => homoskedastic 


##### exploring interactions => NO interactions needed ####
task1_s1 = task1 %>% 
  filter(bachelors < 40)
interaction1 = ggplot(data = task1_s1, aes(x=bachelors, y=happening, color=coastline), alpha=.1) +
  geom_point(shape=1) +
  stat_smooth(aes(group = coastline), method = "lm", formula = y ~ x, se = FALSE)
interaction1
interaction2 = ggplot(data = task1_s1, aes(x=poverty_rate, y=happening, color=coastline), alpha=.1) +
  geom_point(shape=1) +
  stat_smooth(aes(group = coastline), method = "lm", formula = y ~ x, se = FALSE)
interaction2
interaction3 = ggplot(data = task1_s1, aes(x=GeoName, y=happening, color=coastline), alpha=.1) +
  geom_point(shape=1) +
  stat_smooth(aes(group = coastline), method = "lm", formula = y ~ x, se = FALSE)
interaction3 
# NOT INCLUDING states as interacting it with coastline would incease amount of DV by 100%. 
```

Task 2: UCSB Campus Climate Survey - Perceptions of Campus Respectfulness by Respondent Race/Ethnicity
```{r}
# compare proportions
task2_simple = task2%>% 
  select(p_Very.Respectful,p_Respectful,p_Disrespectful,p_Very.Disrespectful)
chisq <- chisq.test(task2_simple)
chisq

# exploring visually
chisq$observed
round(chisq$expected,2)
round(chisq$residuals, 3)
corrplot(chisq$residuals, is.cor = FALSE)

contrib <- 100*chisq$residuals^2/chisq$statistic
round(contrib, 3)
corrplot(contrib, is.cor = FALSE)
```

Task 3: Effect of sex and age on self-consciousness (Taylor Manifest Anxiety Scale)
```{r}
sapply(task3, class)
task3 = task3 %>% 
  mutate(response = case_when(response == "True" ~ 1,
                              response == "False" ~ 0)) %>% 
  mutate(sex_mf = case_when(sex_mf == "Male" ~ 1,
                              sex_mf == "Female" ~ 0))

glm = glm(response ~ age + sex_mf, family = binomial, data = task3) 
summary(glm) # NOT INCLUDED variables because of likely reverse causuality: "consensus", "discuss", "mediaweekly"
plot(glm) # cannot tell, doing Breusch-Pagan test 
bptest(glm) # p = 0 thus residuals most likley NOT constant => heteroskedastic 
predict(glm)

age <- rep(seq(from = 14, to = 94), 2) #create sequence of ages 0 to 100 for both male and female
f <- rep("Female", 81) 
m <- rep("Male", 81) 
mf <- c(f,m)
age_mf <- data.frame(age, mf)
colnames(age_mf) <- c("age", "sex_mf")

probs1 <- predict(glm, newdata = age_mf, type = "response", se.fit = TRUE)

graph1 <- data.frame(age_mf, probs$fit, probs$se.fit)
colnames(graph1) <- c("Age", "Sex", "Probability", "SE")
graph1

probs2 <- predict(glm, newdata = age_mf, type = "response", se.fit = TRUE)

graph2 <- data.frame(age_mf, probs$fit, probs$se.fit)
colnames(graph2) <- c("Age", "Sex", "Probability", "SE")
graph2

##### exploring interactions => NO interactions needed ####
interaction = ggplot(data = task3, aes(x=age, y=response, color=sex_mf), alpha=.1) +
  geom_point(shape=1) +
  stat_smooth(aes(group = sex_mf), method = "lm", formula = y ~ x, se = FALSE)
interaction
```

Task 4: Pyraclostrobin residues on crops
```{r}
task41 = task4 %>%
  select(COMMODITY, `CHEMICAL DETECTED (IF ANY)`, `AMOUNT OF CHEMICAL DETECTED (PPM)`) %>%
  rename(commodity = COMMODITY) %>%
  rename(chemical = `CHEMICAL DETECTED (IF ANY)`) %>%
  rename(ppm = `AMOUNT OF CHEMICAL DETECTED (PPM)`)
task42 = task41 %>% 
  mutate(detected = case_when(ppm > 0 ~ 1,
                              ppm == 0 ~ 0))
task4_simpl = task42 %>% 
  filter(commodity == "STRAWBERRY (ALL OR UNSPEC)" | commodity == "CARROTS (ROOT CROP)") %>% 
  mutate(commodity = case_when(commodity == "STRAWBERRY (ALL OR UNSPEC)" ~ "strawberry",
                   commodity == "CARROTS (ROOT CROP)" ~ "carrot")) %>% 
  filter(chemical == "PYRACLOSTROBIN")

h = ggplot(task4_simpl, aes(ppm)) +
  geom_histogram() +
  facet_wrap("commodity")
h 
qqs = ggplot(task4_simpl, aes(sample = ppm)) +
  geom_qq() + 
  facet_wrap("commodity", scales = "free") 
qqs

strawberry = task4_simpl %>% 
  filter(commodity == "strawberry") %>% 
  pull(ppm)
carrot = task4_simpl %>% 
  filter(commodity == "carrot") %>% 
  pull(ppm)

ftest = var.test(strawberry,carrot) # p=0 thus variances are NOT equal
ftest

#Mann-Whitney U
mwu_emp = wilcox.test(strawberry,carrot)
mwu_emp # p = 0  significant, ranks are NOT equal)

effsize_emp = cliff.delta(strawberry,carrot) # d estimate = 0.26 (small)
```

Task 5: Pesticides by County, California (2014)
```{r}
task5_simpl = task5 %>% 
  rename(subregion = County) %>% 
  rename(pound = `Pounds Active Pesticide Ingredient Used`) %>% 
  rename(rank = `State Ranking`) %>% 
  rename(area = `County Area (Square Miles)`) %>%
  mutate(pound_per_sqmile = pound/area) %>% 
  mutate(subregion = tolower(subregion))

task5_short = task5_simpl %>% 
  filter(subregion == "san joaquin"| subregion ==  "fresno"| subregion == "sutter"| subregion == "kings"| subregion == "stanislaus"| subregion == "merced"| subregion == "madera"| subregion == "santa cruz"| subregion == "sacramento"| subregion == "ventura")

short_pop_and_area = task5_short %>% 
  select(subregion,pound,area)
  
  
pop_and_area = task5_simpl %>% 
  select(subregion, pound, area)


states <- map_data("state")
ca_df <- subset(states, region == "california")
counties <- map_data("county")
ca_county <- subset(counties, region == "california")

ca_top_county <- subset(counties, region == "california") %>% 
  filter(subregion == "san joaquin"| subregion ==  "fresno"| subregion == "sutter"| subregion == "kings"| subregion == "stanislaus"| subregion == "merced"| subregion == "madera"| subregion == "santa cruz"| subregion == "sacramento"| subregion == "ventura")


#### ALL of California ####
ca_base <- ggplot(data = ca_df, mapping = aes(x = long, y = lat, group = group)) +
  coord_fixed(1.3) + 
  geom_polygon(color = "black", fill = "gray") + 
  theme_nothing() + 
  geom_polygon(data = ca_county, fill = NA, color = "white") +
  geom_polygon(color = "black", fill = NA)  # get the state border back on top

cacopa <- inner_join(ca_county, pop_and_area, by = "subregion")
cacopa$pound_per_mile <- cacopa$pound / cacopa$area

ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )

gross <- ca_base + 
      geom_polygon(data = cacopa, aes(fill = pound_per_mile), color = "white") +
      geom_polygon(color = "black", fill = NA) +
      theme_bw() +
      ditch_the_axes +
      scale_fill_gradientn(colours = rev(rainbow(2)), 
                           breaks = c(1, 10, 100, 1000, 10000),
                           trans = "log10")
gross


#### TOP counties in California ####
ca_base <- ggplot(data = ca_df, mapping = aes(x = long, y = lat, group = group)) +
  coord_fixed(1.3) + 
  geom_polygon(color = "black", fill = "gray") + 
  theme_nothing() + 
  geom_polygon(data = ca_top_county, fill = NA, color = "white") +
  geom_polygon(color = "black", fill = NA)  # get the state border back on top

cacopa <- inner_join(ca_top_county, short_pop_and_area, by = "subregion")
cacopa$pound_per_mile <- cacopa$pound / cacopa$area

ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )

gross_top <- ca_base + 
      geom_polygon(data = cacopa, aes(fill = pound_per_mile), color = "white") +
      geom_polygon(color = "black", fill = NA) +
      theme_bw() +
      ditch_the_axes +
      scale_fill_gradientn(colours = rev(rainbow(2)), 
                           breaks = c(1, 10, 100, 1000, 10000),
                           trans = "log10") +
      coord_fixed(xlim = c(-123, -118.0),  ylim = c(34, 39), ratio = 1.3)

gross_top


```
